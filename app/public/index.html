<!DOCTYPE html>
<html>
    <head>
        <title>CARROOM</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Audiowide">
        <style>
            h7 {
              font-family: 'Audiowide', serif;
              font-size: 60px;
              color: #0078d4;
              text-align: center;
              text-shadow: black 4px 4px 7px;
              font-weight: bold;
            }
        </style>
        
    </head>
    <body>
        <h7>CARROOM</h7>
        
        <button id="compareCarsButton">Compare Two Cars</button>

        <div id="comparisonForms" style="display: none;">
            <div id="car1Form" class="car-form">
                <h1>Add First Car</h1>
                <div class="input-container">      
                <label for="year-input">Year:</label>
                <input type="text" id="year-input1">
                </div>
    
                <div class="input-container">
                    <label for="make-input">Make:</label>
                    <input type="text" id="make-input1">
                </div>
    
                <div class="input-container">      
                    <label for="model-input">Model:</label>
                    <input type="text" id="model-input1">
                </div>
    
                <div class="input-container">      
                    
                    <p id="error-message1"></p>
                </div>
            </div>
            
            
            <div id="car2Form" class="car-form">
                <h1>Add Second Car</h1>
                <div class="input-container">      
                <label for="year-input">Year:</label>
                <input type="text" id="year-input2">
                </div>
    
                <div class="input-container">
                    <label for="make-input">Make:</label>
                    <input type="text" id="make-input2">
                </div>
    
                <div class="input-container">      
                    <label for="model-input">Model:</label>
                    <input type="text" id="model-input2">
                </div>
    
                <div class="input-container">      
                    
                    <p id="error-message2"></p>
                </div>
            </div>
            
        </div>

        <button id="compareButton" class="hidden">Compare</button>

        
        
        
        <div id="form-container" style="display: block;">
            <h1>Search Car</h1>
            
            <div class="input-container">      
            <label for="year-input">Year:</label>
            <input type="text" id="year-input">
            </div>

            <div class="input-container">
                <label for="make-input">Make:</label>
                <input type="text" id="make-input">
            </div>

            <div class="input-container">      
                <label for="model-input">Model:</label>
                <input type="text" id="model-input">
            </div>

            <div class="input-container">      
                <button id="searchButton">Get Car</button>
                <p id="error-message"></p>
            </div>
        </div>
        

        <p id="loadingMessage" class="hidden">Searching...</p>
    
        <h2 id="car-specs-header" class="hidden">Specs</h2>
        <div id="car-specs-container" class="hidden">
        </div>

        

        <h3 id="prices-header" class="hidden">Estimated Price Range</h3>
        <div id="price-container" class="hidden">
        </div>

        

        

        <h4 id="car-images-header" class="hidden">Car Images</h4>
        <div id="image-container" class="hidden">
        </div>


        <h5 id="car-ratings-header" class="hidden">Ratings</h5>
        <div id="ratings-container" class="hidden">
        </div>

        <h6 id="comparison-header" class="hidden">CAR 1 & CAR 2</h6>

        <div id="comparisonResults">
            
            <div id="car1Data" class="car-data">

            </div>
            
            <div id="car2Data" class="car-data">

            </div>
        </div>
    
        
        
        <script>
            let errorMessageElement = document.getElementById("error-message");
            let errorMessageElement1 = document.getElementById("error-message1");
            let errorMessageElement2 = document.getElementById("error-message2");
            let carButton = document.getElementById("searchButton");
            let compareButton = document.getElementById("compareButton");

            let specsContainer = document.getElementById("car-specs-container");
            let imageContainer = document.getElementById("image-container"); 
            let priceContainer = document.getElementById("price-container");
            let ratingsContainer = document.getElementById("ratings-container");

            let car1SpecsContainer = document.getElementById("car1Data");
            let car2SpecsContainer = document.getElementById("car2Data");
            
            
            let compareCarsButton = document.getElementById("compareCarsButton");
            let formContainer = document.getElementById("form-container");
            let comparisonForms = document.getElementById("comparisonForms");
            let comparisonResults = document.getElementById("comparisonResults");
            let isComparingTwoCars = false; // State flag

            // User Clicks Comparison/Single Car Search Button Toggle
            compareCarsButton.addEventListener("click", async () => {
                
                isComparingTwoCars = !isComparingTwoCars;

                if(isComparingTwoCars) {
                    document.getElementById("car-specs-header").classList.add("hidden");
                    document.getElementById("prices-header").classList.add("hidden");
                    document.getElementById("car-images-header").classList.add("hidden");
                    document.getElementById("car-ratings-header").classList.add("hidden");


                    while(specsContainer.firstChild) {
                        specsContainer.removeChild(specsContainer.firstChild);
                    }
                    
                    
                    while(priceContainer.firstChild) {
                        priceContainer.removeChild(priceContainer.firstChild);
                    }

                    

                    while(imageContainer.firstChild) {
                        imageContainer.removeChild(imageContainer.firstChild);
                    }

                    while(ratingsContainer.firstChild) {
                        ratingsContainer.removeChild(ratingsContainer.firstChild);
                    }

                    
                    // If currently searching for one car, switch to compare two cars
                    compareCarsButton.textContent = "Search For One Car";
                    formContainer.style.display = "none"; // Hide the single car search form
                    comparisonForms.style.display = "flex"; // Show the comparison forms
                    comparisonResults.style.display = "flex"; // Show the comparison results
                    compareButton.classList.remove("hidden");
                    
                } else {
                    document.getElementById("comparison-header").classList.add("hidden");

                    while(car1SpecsContainer.firstChild) {
                        car1SpecsContainer.removeChild(car1SpecsContainer.firstChild);
                    }

                    while(car2SpecsContainer.firstChild) {
                        car2SpecsContainer.removeChild(car2SpecsContainer.firstChild);
                    }

                    // If currently comparing two cars, switch to search for one car
                    compareCarsButton.textContent = "Compare Two Cars";
                    formContainer.style.display = "block"; // Show the single car search form
                    comparisonForms.style.display = "none"; // Hide the comparison forms
                    comparisonResults.style.display = "none"; // Hide the comparison results
                    compareButton.classList.add("hidden");
                    
                }

            });
            
            
            
            
            
            


            // Compare Button is Clicked for Two Cars
            compareButton.addEventListener("click", async () => {
                
                
                
                document.getElementById("comparison-header").classList.add("hidden");

                document.getElementById("loadingMessage").classList.remove("hidden");
                
                yearInput1 = document.getElementById("year-input1").value;
                makeInput1 = document.getElementById("make-input1").value;
                modelInput1 = document.getElementById("model-input1").value;

                yearInput2 = document.getElementById("year-input2").value;
                makeInput2 = document.getElementById("make-input2").value;
                modelInput2 = document.getElementById("model-input2").value;

                


                

                while(car1SpecsContainer.firstChild) {
                    car1SpecsContainer.removeChild(car1SpecsContainer.firstChild);
                }

                while(car2SpecsContainer.firstChild) {
                    car2SpecsContainer.removeChild(car2SpecsContainer.firstChild);
                }




                if (!yearInput1 || !makeInput1 || !modelInput1 || !yearInput2 || !makeInput2 || !modelInput2){
                    document.getElementById("loadingMessage").classList.add("hidden");
                    errorMessageElement1.textContent = "Please enter Year, Make, and Model";
                    errorMessageElement2.textContent = "Please enter Year, Make, and Model";
                    return;
                    
                }else if (!yearInput1 || !makeInput1 || !modelInput1){
                    document.getElementById("loadingMessage").classList.add("hidden");
                    errorMessageElement1.textContent = "Please enter Year, Make, and Model";
                    return;
                    
                }else if (!yearInput2 || !makeInput2 || !modelInput2){
                    document.getElementById("loadingMessage").classList.add("hidden");
                    errorMessageElement2.textContent = "Please enter Year, Make, and Model";
                    return;
                    
                }
                errorMessageElement1.textContent = "";
                errorMessageElement2.textContent = "";


                
                let invalidCar1 = false;
                try{ 
                    // Car 1 Specs
                    let carSpecResponse = await fetch(`/cars?year=${yearInput1}&make=${makeInput1}&model=${modelInput1}`);
                        
                        if(!carSpecResponse.ok) {
                            if (carSpecResponse.status === 404){
                                document.getElementById("loadingMessage").classList.add("hidden");
                                throw new Error("Car not found");
                            }
                            let errorData = await carSpecResponse.json();
                            document.getElementById("loadingMessage").classList.add("hidden");
                            throw new Error(errorData.message || 'An error occurred while fetching the car.');
                            
                        } 
                        let carsData = await carSpecResponse.json();

                        if (carsData.length === 0){
                            invalidCar1 = true;
                            document.getElementById("loadingMessage").classList.add("hidden");
                            throw new Error("Car not found");
                        }

                        
                        
                                
                        carsData.forEach(car => {
                        
                            let card = document.createElement("div");
                            card.classList.add("spec-card-compare");

                            // Add make
                            let makeDiv = document.createElement("div");
                            makeDiv.textContent = `Make: ${car.make}`;
                            card.appendChild(makeDiv);

                            // Add model
                            let modelDiv = document.createElement("div");
                            modelDiv.textContent = `Model: ${car.model}`;
                            card.appendChild(modelDiv);

                            // Add year
                            let yearDiv = document.createElement("div");
                            yearDiv.textContent = `Year: ${car.year}`;
                            card.appendChild(yearDiv);

                            // Add class
                            let classDiv = document.createElement("div");
                            classDiv.textContent = `Class: ${car.class}`;
                            card.appendChild(classDiv);

                            // Add fuel type
                            let fuelTypeDiv = document.createElement("div");
                            fuelTypeDiv.textContent = `Fuel Type: ${car.fuel_type}`;
                            card.appendChild(fuelTypeDiv);

                            // Add drivetrain
                            let driveDiv = document.createElement("div");
                            driveDiv.textContent = `Drivetrain: ${car.drive}`;
                            card.appendChild(driveDiv);

                            // Add cylinders
                            let cylinderDiv = document.createElement("div");
                            cylinderDiv.textContent = `Cylinders: ${car.cylinders}`;
                            card.appendChild(cylinderDiv);

                            // Add transmission
                            let transDiv = document.createElement("div");
                            transDiv.textContent = `Transmission: ${car.transmission}`;
                            card.appendChild(transDiv);

                            // Add city MPG
                            let cityMPGDiv = document.createElement("div");
                            cityMPGDiv.textContent = `City MPG: ${car.city_mpg}`;
                            card.appendChild(cityMPGDiv);

                            // Add highway MPG
                            let hwyMPGDiv = document.createElement("div");
                            hwyMPGDiv.textContent = `Highway MPG: ${car.highway_mpg}`;
                            card.appendChild(hwyMPGDiv);

                            // Add combination MPG
                            let combMPGDiv = document.createElement("div");
                            combMPGDiv.textContent = `Combination MPG: ${car.combination_mpg}`;
                            card.appendChild(combMPGDiv);

                            // Append the card to the container
                            car1SpecsContainer.appendChild(card);
                        });   
                }catch(error) {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        errorMessageElement1.textContent = error.message || 'An error occurred while fetching the car.';
                };



                
                
                
                let invalidCar2 = false;
                try{ 
                    // Car 2 Specs
                    let carSpecResponse2 = await fetch(`/cars?year=${yearInput2}&make=${makeInput2}&model=${modelInput2}`);
                        
                        if(!carSpecResponse2.ok) {
                            if (carSpecResponse2.status === 404){
                                document.getElementById("loadingMessage").classList.add("hidden");
                                throw new Error("Car not found");
                            }
                            let errorData = await carSpecResponse2.json();
                            document.getElementById("loadingMessage").classList.add("hidden");
                            throw new Error(errorData.message || 'An error occurred while fetching the car.');
                            
                        } 
                        let carsData = await carSpecResponse2.json();

                        if (carsData.length === 0){
                            invalidCar2 = true;
                            if (!invalidCar1){
                                while(car1SpecsContainer.firstChild) {
                                    car1SpecsContainer.removeChild(car1SpecsContainer.firstChild);
                                }
                            }
                            document.getElementById("loadingMessage").classList.add("hidden");
                            throw new Error("Car not found");
                        }

                        if (invalidCar1){
                            throw new Error("Car 1 not found");
                        }

                        
                        
                                
                        carsData.forEach(car => {
                        
                            let card = document.createElement("div");
                            card.classList.add("spec-card-compare");

                            // Add make
                            let makeDiv = document.createElement("div");
                            makeDiv.textContent = `Make: ${car.make}`;
                            card.appendChild(makeDiv);

                            // Add model
                            let modelDiv = document.createElement("div");
                            modelDiv.textContent = `Model: ${car.model}`;
                            card.appendChild(modelDiv);

                            // Add year
                            let yearDiv = document.createElement("div");
                            yearDiv.textContent = `Year: ${car.year}`;
                            card.appendChild(yearDiv);

                            // Add class
                            let classDiv = document.createElement("div");
                            classDiv.textContent = `Class: ${car.class}`;
                            card.appendChild(classDiv);

                            // Add fuel type
                            let fuelTypeDiv = document.createElement("div");
                            fuelTypeDiv.textContent = `Fuel Type: ${car.fuel_type}`;
                            card.appendChild(fuelTypeDiv);

                            // Add drivetrain
                            let driveDiv = document.createElement("div");
                            driveDiv.textContent = `Drivetrain: ${car.drive}`;
                            card.appendChild(driveDiv);

                            // Add cylinders
                            let cylinderDiv = document.createElement("div");
                            cylinderDiv.textContent = `Cylinders: ${car.cylinders}`;
                            card.appendChild(cylinderDiv);

                            // Add transmission
                            let transDiv = document.createElement("div");
                            transDiv.textContent = `Transmission: ${car.transmission}`;
                            card.appendChild(transDiv);

                            // Add city MPG
                            let cityMPGDiv = document.createElement("div");
                            cityMPGDiv.textContent = `City MPG: ${car.city_mpg}`;
                            card.appendChild(cityMPGDiv);

                            // Add highway MPG
                            let hwyMPGDiv = document.createElement("div");
                            hwyMPGDiv.textContent = `Highway MPG: ${car.highway_mpg}`;
                            card.appendChild(hwyMPGDiv);

                            // Add combination MPG
                            let combMPGDiv = document.createElement("div");
                            combMPGDiv.textContent = `Combination MPG: ${car.combination_mpg}`;
                            card.appendChild(combMPGDiv);

                            // Append the card to the container
                            car2SpecsContainer.appendChild(card);
                        });   
                }catch(error) {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        errorMessageElement2.textContent = error.message || 'An error occurred while fetching the car.';
                };


                
                

                

                function getPriceBounds(year) {
                    let currentYear = new Date().getFullYear();
                    let age = currentYear - year;

                    if (age < 5) {
                        return { lowerBound: 20000, upperBound: 5000000 }; // Newer used cars
                    } else if (age < 10) {
                        return { lowerBound: 7000, upperBound: 2000000 }; // Moderately old cars
                    } else {
                        return { lowerBound: 2000, upperBound: 150000 }; // Older used cars
                    }
                }

                function extractPrices(text, year){
                    let bounds = getPriceBounds(year);
                    // Look for patterns like $XX,XXX.XX or $XX.XX or $XXXX
                    let priceRegex = /\$\d{1,3}(,\d{3})*(\.\d{2})?/g;
                    let matches = text.match(priceRegex);
                    let prices = matches ? matches.map(match => match.replace(/[\$,]/g, '')) : [];
                    let filteredPrices = [];
                    let price;

                    for (price of prices){
                        let numericPrice = parseFloat(price);
                        if (numericPrice >= bounds.lowerBound && numericPrice <= bounds.upperBound){
                            filteredPrices.push(matches[prices.indexOf(price)]);
                            if (filteredPrices.length >= 3) break;
                        }
                    }
                    // Return first 3 prices
                    return filteredPrices;
                }
                
                
                // If car 1 & car 2 specs were found
                if (!invalidCar1 && !invalidCar2){
                    
                    // Car 1 Prices
                    await fetch(`/webscraper?year=${yearInput1}&make=${makeInput1}&model=${modelInput1}`)
                    .then(response => {
                        if(response.ok) {
                            return response.json();
                        } else {
                            if(response.status === 404) {
                                document.getElementById("loadingMessage").classList.add("hidden");
                                throw { message: "Price data not found" };
                            }
                            document.getElementById("loadingMessage").classList.add("hidden");
                            return response.json().then(error => { throw error });
                        }
                    })
                    .then(data => {
                        let textData = data.data;
                        let prices = extractPrices(textData, yearInput1);
                        console.log(prices);

                        let numericPrices = prices.map(price => parseFloat(price.replace(/[\$,]/g, '')));
                        let minValue = Math.min(...numericPrices);
                        let maxValue = Math.max(...numericPrices);

                        let formattedMinValue = prices.find(price => parseFloat(price.replace(/[\$,]/g, '')) === minValue);
                        let formattedMaxValue = prices.find(price => parseFloat(price.replace(/[\$,]/g, '')) === maxValue);

                        
                        
                        let priceCard = document.createElement("div");
                        priceCard.classList.add("price-card-compare");
                        priceCard.textContent = `${formattedMinValue} - ${formattedMaxValue}`;
                        car1SpecsContainer.appendChild(priceCard);

                        

                        
                    })
                    .catch(error => {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        errorMessageElement1.textContent = error.message || 'An error occurred while fetching the price data.';
                    });




                    
                    
                    // Car 1 Image
                    await fetch(`/GetImageUrl?searchTerm=&year=${yearInput1}&make=${makeInput1}&model=${modelInput1}`)
                    .then(response => {
                        if(response.ok) {
                            return response.text();
                        } else {

                            document.getElementById("loadingMessage").classList.add("hidden");
                            throw new Error("Car image data not found");
                        }
                    })
                    .then(str => {
                        let parser = new DOMParser();
                        let xml = parser.parseFromString(str, "application/xml");
                        let imageUrl = xml.getElementsByTagName("string")[0].textContent;
                        console.log(imageUrl);

                        let imageElement = document.createElement("img");
                        imageElement.src = imageUrl;
                        imageElement.className = 'car-image';
                        
                        car1SpecsContainer.insertBefore(imageElement, car1SpecsContainer.firstChild);
                         
                    })
                    .catch(error => {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        console.error("Error:", error);
                    });

                    

                    // Safety Ratings Car 1
                    await fetch(`/SafetyRatings?year=${yearInput1}&make=${makeInput1}&model=${modelInput1}`)
                    .then(response => {
                        if(response.ok) {
                            return response.json();

                        } else {
                            if(response.status === 404) {
                                document.getElementById("loadingMessage").classList.add("hidden");
                                throw { message: "Safety ratings data not found" };
                            }
                            document.getElementById("loadingMessage").classList.add("hidden");
                            return response.json().then(error => { throw error });
                        }
                        
                    })
                    .then(data => {
                        let vehicleIds = data.Results.map(result => result.VehicleId);
                        return Promise.all(vehicleIds.map(vehicleId => {
                            return fetch(`/SafetyRatings/VehicleId/${vehicleId}`)
                            .then(response => {
                                if (!response.ok){
                                    throw new Error('Vehicle safety rating data not found');
                                }
                                return response.json();
                            });
                        }));
                    })
                    .then(allRatings => {
                        let imageAppended = false;
                        let ratingsFound = false;

                        allRatings.forEach(ratingData => {
                            
                            if (ratingData.Results.length !== 0){
                                ratingsFound = true;
                                
                                let rating = ratingData.Results[0];
                                let card = document.createElement("div");
                                
                                card.classList.add("rating-card-compare");


                                // description
                                let descriptionDiv = document.createElement("div");
                                descriptionDiv.textContent = `Description: ${rating.VehicleDescription}`;
                                card.appendChild(descriptionDiv);

                                // investigation count
                                let investigationDiv = document.createElement("div");
                                investigationDiv.textContent = `Investigation Count: ${rating.InvestigationCount}`;
                                card.appendChild(investigationDiv);
                                
                                // recalls count
                                let recallsDiv = document.createElement("div");
                                recallsDiv.textContent = `Recalls Count: ${rating.RecallsCount}`;
                                card.appendChild(recallsDiv);

                                // complaints count
                                let complaintsDiv = document.createElement("div");
                                complaintsDiv.textContent = `Complaints Count: ${rating.ComplaintsCount}`;
                                card.appendChild(complaintsDiv);

                                // lane departure warning
                                let laneDepDiv = document.createElement("div");
                                laneDepDiv.textContent = `NHTSA Lane Departure Warning: ${rating.NHTSALaneDepartureWarning}`;
                                card.appendChild(laneDepDiv);

                                // forward collision warning
                                let forwColDiv = document.createElement("div");
                                forwColDiv.textContent = `NHTSA Forward Collision Warning: ${rating.NHTSAForwardCollisionWarning}`;
                                card.appendChild(forwColDiv);

                                // electronic stability control
                                let elecStabDiv = document.createElement("div");
                                elecStabDiv.textContent = `NHTSA Electronic Stability Control: ${rating.NHTSAElectronicStabilityControl}`;
                                card.appendChild(elecStabDiv);

                                // side pole crash rating
                                let spRatingDiv = document.createElement("div");
                                spRatingDiv.textContent = `Side Pole Crash Rating: ${rating.SidePoleCrashRating}`;
                                card.appendChild(spRatingDiv);

                                // rollover possibility
                                let rolloverPosDiv = document.createElement("div");
                                rolloverPosDiv.textContent = `Rollover Possibility: ${rating.RolloverPossibility}`;
                                card.appendChild(rolloverPosDiv);

                                // rollover rating
                                let rolloverRatingDiv = document.createElement("div");
                                rolloverRatingDiv.textContent = `Rollover Rating: ${rating.RolloverRating}`;
                                card.appendChild(rolloverRatingDiv);

                                // side crash passenger side rating
                                let sideCPSDiv = document.createElement("div");
                                sideCPSDiv.textContent = `Side Crash Passenger Side Rating: ${rating.SideCrashPassengersideRating}`;
                                card.appendChild(sideCPSDiv);

                                // side crash driver side rating
                                let sideCDSDiv = document.createElement("div");
                                sideCDSDiv.textContent = `Side Crash Driver Side Rating: ${rating.SideCrashDriversideRating}`;
                                card.appendChild(sideCDSDiv);

                                // overall side crash rating
                                let overallSCRDiv = document.createElement("div");
                                overallSCRDiv.textContent = `Overall Side Crash Rating: ${rating.OverallSideCrashRating}`;
                                card.appendChild(overallSCRDiv);

                                // front crash passenger side rating
                                let frontCPSDiv = document.createElement("div");
                                frontCPSDiv.textContent = `Front Crash Passenger Side Rating: ${rating.FrontCrashPassengersideRating}`;
                                card.appendChild(frontCPSDiv);

                                // front crash driver side rating
                                let frontCDSDiv = document.createElement("div");
                                frontCDSDiv.textContent = `Front Crash Driver Side Rating: ${rating.FrontCrashDriversideRating}`;
                                card.appendChild(frontCDSDiv);

                                // overall front crash rating
                                let overallFCRDiv = document.createElement("div");
                                overallFCRDiv.textContent = `Overall Front Crash Rating: ${rating.OverallFrontCrashRating}`;
                                card.appendChild(overallFCRDiv);

                                // overall rating
                                let overallRDiv = document.createElement("div");
                                overallRDiv.textContent = `Overall Rating: ${rating.OverallRating}`;
                                card.appendChild(overallRDiv);

                                // Side Pole Picture
                                if (rating.SidePolePicture){
                                    let imgSP = document.createElement("img");
                                    imgSP.src = rating.SidePolePicture;
                                    //imgSP.className = '';
                                    imgSP.alt = "Side Pole Picture";
                                    card.appendChild(imgSP);
                                }

                                // Side Crash Picture
                                if (rating.SideCrashPicture){
                                    let imgSC = document.createElement("img");
                                    imgSC.src = rating.SideCrashPicture;
                                    //imgSC.className = '';
                                    imgSC.alt = "Side Crash Picture";
                                    card.appendChild(imgSC);
                                }

                                // Front Crash Picture
                                if (rating.FrontCrashPicture){
                                    let imgFC = document.createElement("img");
                                    imgFC.src = rating.FrontCrashPicture;
                                    //imgFC.className = '';
                                    imgFC.alt = "Front Crash Picture";
                                    card.appendChild(imgFC);
                                }

                                

                                // create and append download links to crash videos
                                function appendDownloadLink(videoUrl, description) {
                                    if (videoUrl) {
                                        let downloadLink = document.createElement('a');
                                        downloadLink.href = videoUrl;
                                        downloadLink.textContent = `Download ${description}`;
                                        downloadLink.className = 'download-video-link';
                                        downloadLink.download = ""; // suggest download on click
                                        card.appendChild(downloadLink); 
                                    }
                                }

                                
                                appendDownloadLink(rating.FrontCrashVideo, "Front Crash Video");
                                appendDownloadLink(rating.SideCrashVideo, "Side Crash Video");
                                appendDownloadLink(rating.SidePoleVideo, "Side Pole Video");
                                
                                
                                car1SpecsContainer.appendChild(card);

                                if (!imageAppended ) { //fix this!
                                
                                    // image
                                    if (rating.VehiclePicture){
                                        let img = document.createElement("img");
                                        img.src = rating.VehiclePicture;
                                        img.className = 'car-image';
                                        img.alt = "Vehicle Safety Rating Picture";
                                        car1SpecsContainer.insertBefore(img, car1SpecsContainer.firstChild);
                                        imageAppended = true; 
                                    }
                                    
                                }

                            } 
                            
                        });
                        
                        if (!ratingsFound){
                            let noRatingsCard = document.createElement("div");
                            noRatingsCard.classList.add("rating-card");


                            // No ratings results
                            noRatingsCard.textContent = `No Safety Ratings Results From NHTSA`;
                            car1SpecsContainer.appendChild(noRatingsCard);
                        }

                    
                    })
                    .catch(error => {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        errorMessageElement1.textContent = error.message || 'An error occurred while fetching the ratings data.';
                    });

                    //put recalls etc here..




                    // Car 2 Prices
                    await fetch(`/webscraper?year=${yearInput2}&make=${makeInput2}&model=${modelInput2}`)
                    .then(response => {
                        if(response.ok) {
                            return response.json();
                        } else {
                            if(response.status === 404) {
                                document.getElementById("loadingMessage").classList.add("hidden");
                                throw { message: "Price data not found" };
                            }
                            document.getElementById("loadingMessage").classList.add("hidden");
                            return response.json().then(error => { throw error });
                        }
                    })
                    .then(data => {
                        let textData = data.data;
                        let prices = extractPrices(textData, yearInput2);
                        console.log(prices);

                        let numericPrices = prices.map(price => parseFloat(price.replace(/[\$,]/g, '')));
                        let minValue = Math.min(...numericPrices);
                        let maxValue = Math.max(...numericPrices);

                        let formattedMinValue = prices.find(price => parseFloat(price.replace(/[\$,]/g, '')) === minValue);
                        let formattedMaxValue = prices.find(price => parseFloat(price.replace(/[\$,]/g, '')) === maxValue);

                        
                        
                        let priceCard = document.createElement("div");
                        priceCard.classList.add("price-card-compare");
                        priceCard.textContent = `${formattedMinValue} - ${formattedMaxValue}`;
                        car2SpecsContainer.appendChild(priceCard);

                        

                        
                    })
                    .catch(error => {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        errorMessageElement2.textContent = error.message || 'An error occurred while fetching the price data.';
                    });




                    
                    
                    // Car Image
                    await fetch(`/GetImageUrl?searchTerm=&year=${yearInput2}&make=${makeInput2}&model=${modelInput2}`)
                    .then(response => {
                        if(response.ok) {
                            return response.text();
                        } else {

                            document.getElementById("loadingMessage").classList.add("hidden");
                            throw new Error("Car image data not found");
                        }
                    })
                    .then(str => {
                        let parser = new DOMParser();
                        let xml = parser.parseFromString(str, "application/xml");
                        let imageUrl = xml.getElementsByTagName("string")[0].textContent;
                        console.log(imageUrl);

                        let imageElement = document.createElement("img");
                        imageElement.src = imageUrl;
                        imageElement.className = 'car-image';
                        
                        car2SpecsContainer.insertBefore(imageElement, car2SpecsContainer.firstChild);
                         
                    })
                    .catch(error => {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        console.error("Error:", error);
                    });

                    

                    // Safety Ratings
                    await fetch(`/SafetyRatings?year=${yearInput2}&make=${makeInput2}&model=${modelInput2}`)
                    .then(response => {
                        if(response.ok) {
                            return response.json();

                        } else {
                            if(response.status === 404) {
                                document.getElementById("loadingMessage").classList.add("hidden");
                                throw { message: "Safety ratings data not found" };
                            }
                            document.getElementById("loadingMessage").classList.add("hidden");
                            return response.json().then(error => { throw error });
                        }
                        
                    })
                    .then(data => {
                        let vehicleIds = data.Results.map(result => result.VehicleId);
                        return Promise.all(vehicleIds.map(vehicleId => {
                            return fetch(`/SafetyRatings/VehicleId/${vehicleId}`)
                            .then(response => {
                                if (!response.ok){
                                    throw new Error('Vehicle safety rating data not found');
                                }
                                return response.json();
                            });
                        }));
                    })
                    .then(allRatings => {
                        let imageAppended = false;
                        let ratingsFound = false;

                        allRatings.forEach(ratingData => {
                            
                            if (ratingData.Results.length !== 0){
                                ratingsFound = true;
                                
                                let rating = ratingData.Results[0];
                                let card = document.createElement("div");
                                
                                card.classList.add("rating-card-compare");


                                // description
                                let descriptionDiv = document.createElement("div");
                                descriptionDiv.textContent = `Description: ${rating.VehicleDescription}`;
                                card.appendChild(descriptionDiv);

                                // investigation count
                                let investigationDiv = document.createElement("div");
                                investigationDiv.textContent = `Investigation Count: ${rating.InvestigationCount}`;
                                card.appendChild(investigationDiv);
                                
                                // recalls count
                                let recallsDiv = document.createElement("div");
                                recallsDiv.textContent = `Recalls Count: ${rating.RecallsCount}`;
                                card.appendChild(recallsDiv);

                                // complaints count
                                let complaintsDiv = document.createElement("div");
                                complaintsDiv.textContent = `Complaints Count: ${rating.ComplaintsCount}`;
                                card.appendChild(complaintsDiv);

                                // lane departure warning
                                let laneDepDiv = document.createElement("div");
                                laneDepDiv.textContent = `NHTSA Lane Departure Warning: ${rating.NHTSALaneDepartureWarning}`;
                                card.appendChild(laneDepDiv);

                                // forward collision warning
                                let forwColDiv = document.createElement("div");
                                forwColDiv.textContent = `NHTSA Forward Collision Warning: ${rating.NHTSAForwardCollisionWarning}`;
                                card.appendChild(forwColDiv);

                                // electronic stability control
                                let elecStabDiv = document.createElement("div");
                                elecStabDiv.textContent = `NHTSA Electronic Stability Control: ${rating.NHTSAElectronicStabilityControl}`;
                                card.appendChild(elecStabDiv);

                                // side pole crash rating
                                let spRatingDiv = document.createElement("div");
                                spRatingDiv.textContent = `Side Pole Crash Rating: ${rating.SidePoleCrashRating}`;
                                card.appendChild(spRatingDiv);

                                // rollover possibility
                                let rolloverPosDiv = document.createElement("div");
                                rolloverPosDiv.textContent = `Rollover Possibility: ${rating.RolloverPossibility}`;
                                card.appendChild(rolloverPosDiv);

                                // rollover rating
                                let rolloverRatingDiv = document.createElement("div");
                                rolloverRatingDiv.textContent = `Rollover Rating: ${rating.RolloverRating}`;
                                card.appendChild(rolloverRatingDiv);

                                // side crash passenger side rating
                                let sideCPSDiv = document.createElement("div");
                                sideCPSDiv.textContent = `Side Crash Passenger Side Rating: ${rating.SideCrashPassengersideRating}`;
                                card.appendChild(sideCPSDiv);

                                // side crash driver side rating
                                let sideCDSDiv = document.createElement("div");
                                sideCDSDiv.textContent = `Side Crash Driver Side Rating: ${rating.SideCrashDriversideRating}`;
                                card.appendChild(sideCDSDiv);

                                // overall side crash rating
                                let overallSCRDiv = document.createElement("div");
                                overallSCRDiv.textContent = `Overall Side Crash Rating: ${rating.OverallSideCrashRating}`;
                                card.appendChild(overallSCRDiv);

                                // front crash passenger side rating
                                let frontCPSDiv = document.createElement("div");
                                frontCPSDiv.textContent = `Front Crash Passenger Side Rating: ${rating.FrontCrashPassengersideRating}`;
                                card.appendChild(frontCPSDiv);

                                // front crash driver side rating
                                let frontCDSDiv = document.createElement("div");
                                frontCDSDiv.textContent = `Front Crash Driver Side Rating: ${rating.FrontCrashDriversideRating}`;
                                card.appendChild(frontCDSDiv);

                                // overall front crash rating
                                let overallFCRDiv = document.createElement("div");
                                overallFCRDiv.textContent = `Overall Front Crash Rating: ${rating.OverallFrontCrashRating}`;
                                card.appendChild(overallFCRDiv);

                                // overall rating
                                let overallRDiv = document.createElement("div");
                                overallRDiv.textContent = `Overall Rating: ${rating.OverallRating}`;
                                card.appendChild(overallRDiv);

                                // Side Pole Picture
                                if (rating.SidePolePicture){
                                    let imgSP = document.createElement("img");
                                    imgSP.src = rating.SidePolePicture;
                                    //imgSP.className = '';
                                    imgSP.alt = "Side Pole Picture";
                                    card.appendChild(imgSP);
                                }

                                // Side Crash Picture
                                if (rating.SideCrashPicture){
                                    let imgSC = document.createElement("img");
                                    imgSC.src = rating.SideCrashPicture;
                                    //imgSC.className = '';
                                    imgSC.alt = "Side Crash Picture";
                                    card.appendChild(imgSC);
                                }

                                // Front Crash Picture
                                if (rating.FrontCrashPicture){
                                    let imgFC = document.createElement("img");
                                    imgFC.src = rating.FrontCrashPicture;
                                    //imgFC.className = '';
                                    imgFC.alt = "Front Crash Picture";
                                    card.appendChild(imgFC);
                                }

                                

                                // create and append download links to crash videos
                                function appendDownloadLink(videoUrl, description) {
                                    if (videoUrl) {
                                        let downloadLink = document.createElement('a');
                                        downloadLink.href = videoUrl;
                                        downloadLink.textContent = `Download ${description}`;
                                        downloadLink.className = 'download-video-link';
                                        downloadLink.download = ""; // suggest download on click
                                        card.appendChild(downloadLink); 
                                    }
                                }

                                
                                appendDownloadLink(rating.FrontCrashVideo, "Front Crash Video");
                                appendDownloadLink(rating.SideCrashVideo, "Side Crash Video");
                                appendDownloadLink(rating.SidePoleVideo, "Side Pole Video");
                                
                                
                                car2SpecsContainer.appendChild(card);

                                if (!imageAppended ) { //Fix this!
                                
                                    // image
                                    if (rating.VehiclePicture){
                                        let img = document.createElement("img");
                                        img.src = rating.VehiclePicture;
                                        img.className = 'car-image';
                                        img.alt = "Vehicle Safety Rating Picture";
                                        car2SpecsContainer.insertBefore(img, car2SpecsContainer.firstChild);
                                        imageAppended = true; 
                                    }
                                    
                                }

                            } 
                            
                        });
                        
                        if (!ratingsFound){
                            let noRatingsCard = document.createElement("div");
                            noRatingsCard.classList.add("rating-card");


                            // No ratings results
                            noRatingsCard.textContent = `No Safety Ratings Results From NHTSA`;
                            car2SpecsContainer.appendChild(noRatingsCard);
                        }

                    
                    })
                    .catch(error => {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        errorMessageElement2.textContent = error.message || 'An error occurred while fetching the ratings data.';
                    });

                    //put recalls etc here..


                }else{
                    document.getElementById("loadingMessage").classList.add("hidden");

                    throw { message: "Car not found" };
                }






                


                // Hide Searching Message
                document.getElementById("loadingMessage").classList.add("hidden");
                
                // Show Specs
                /*document.getElementById("car-specs-header").classList.remove("hidden");
                document.getElementById("car-specs-container").classList.remove("hidden");
                

                // Show Prices
                document.getElementById("prices-header").classList.remove("hidden");
                document.getElementById("price-container").classList.remove("hidden");
                

                // Show Images
                document.getElementById("car-images-header").classList.remove("hidden");
                document.getElementById("image-container").classList.remove("hidden");

                // Show Ratings
                document.getElementById("car-ratings-header").classList.remove("hidden");
                document.getElementById("ratings-container").classList.remove("hidden");
                
                */
                
                let year1 = yearInput1.toUpperCase();
                let make1 = makeInput1.toUpperCase();
                let model1 = modelInput1.toUpperCase();

                let year2 = yearInput2.toUpperCase();
                let make2 = makeInput2.toUpperCase();
                let model2 = modelInput2.toUpperCase();


                
                document.getElementById("comparison-header").innerText = `${year1} ${make1} ${model1} & ${year2} ${make2} ${model2}`
                document.getElementById("comparison-header").classList.remove("hidden");

                // Auto scroll down to specs 
                comparisonResults.scrollIntoView({ behavior: 'smooth', block: 'start' }); 

                


   
            }) //end of button click





            
            
            
            
            
            
            
            
            
            // Single Car Search
            carButton.addEventListener("click", async () => {
                
                
                
                document.getElementById("car-specs-header").classList.add("hidden");
                document.getElementById("prices-header").classList.add("hidden");
                document.getElementById("car-images-header").classList.add("hidden");
                document.getElementById("car-ratings-header").classList.add("hidden");

                document.getElementById("loadingMessage").classList.remove("hidden");
                
                yearInput = document.getElementById("year-input").value;
                makeInput = document.getElementById("make-input").value;
                modelInput = document.getElementById("model-input").value;

                

                

                

                while(specsContainer.firstChild) {
                    specsContainer.removeChild(specsContainer.firstChild);
                }
                
                
                while(priceContainer.firstChild) {
                    priceContainer.removeChild(priceContainer.firstChild);
                }

                

                while(imageContainer.firstChild) {
                    imageContainer.removeChild(imageContainer.firstChild);
                }

                while(ratingsContainer.firstChild) {
                    ratingsContainer.removeChild(ratingsContainer.firstChild);
                }




                if (!yearInput || !makeInput || !modelInput){
                    document.getElementById("loadingMessage").classList.add("hidden");
                    errorMessageElement.textContent = "Please enter Year, Make, and Model";
                    return;
                }
                errorMessageElement.textContent = "";

                
                let invalidCar = false;
                try{ 
                    // Car Specs
                    let carSpecResponse = await fetch(`/cars?year=${yearInput}&make=${makeInput}&model=${modelInput}`);
                        
                        if(!carSpecResponse.ok) {
                            if (carSpecResponse.status === 404){
                                document.getElementById("loadingMessage").classList.add("hidden");
                                throw new Error("Car not found");
                            }
                            let errorData = await carSpecResponse.json();
                            document.getElementById("loadingMessage").classList.add("hidden");
                            throw new Error(errorData.message || 'An error occurred while fetching the car.');
                            
                        } 
                        let carsData = await carSpecResponse.json();

                        if (carsData.length === 0){
                            invalidCar = true;
                            document.getElementById("loadingMessage").classList.add("hidden");
                            throw new Error("Car not found");
                        }

                        
                        
                                
                        carsData.forEach(car => {
                        
                            let card = document.createElement("div");
                            card.classList.add("spec-card");

                            // Add make
                            let makeDiv = document.createElement("div");
                            makeDiv.textContent = `Make: ${car.make}`;
                            card.appendChild(makeDiv);

                            // Add model
                            let modelDiv = document.createElement("div");
                            modelDiv.textContent = `Model: ${car.model}`;
                            card.appendChild(modelDiv);

                            // Add year
                            let yearDiv = document.createElement("div");
                            yearDiv.textContent = `Year: ${car.year}`;
                            card.appendChild(yearDiv);

                            // Add class
                            let classDiv = document.createElement("div");
                            classDiv.textContent = `Class: ${car.class}`;
                            card.appendChild(classDiv);

                            // Add fuel type
                            let fuelTypeDiv = document.createElement("div");
                            fuelTypeDiv.textContent = `Fuel Type: ${car.fuel_type}`;
                            card.appendChild(fuelTypeDiv);

                            // Add drivetrain
                            let driveDiv = document.createElement("div");
                            driveDiv.textContent = `Drivetrain: ${car.drive}`;
                            card.appendChild(driveDiv);

                            // Add cylinders
                            let cylinderDiv = document.createElement("div");
                            cylinderDiv.textContent = `Cylinders: ${car.cylinders}`;
                            card.appendChild(cylinderDiv);

                            // Add transmission
                            let transDiv = document.createElement("div");
                            transDiv.textContent = `Transmission: ${car.transmission}`;
                            card.appendChild(transDiv);

                            // Add city MPG
                            let cityMPGDiv = document.createElement("div");
                            cityMPGDiv.textContent = `City MPG: ${car.city_mpg}`;
                            card.appendChild(cityMPGDiv);

                            // Add highway MPG
                            let hwyMPGDiv = document.createElement("div");
                            hwyMPGDiv.textContent = `Highway MPG: ${car.highway_mpg}`;
                            card.appendChild(hwyMPGDiv);

                            // Add combination MPG
                            let combMPGDiv = document.createElement("div");
                            combMPGDiv.textContent = `Combination MPG: ${car.combination_mpg}`;
                            card.appendChild(combMPGDiv);

                            // Append the card to the container
                            specsContainer.appendChild(card);
                        });   
                }catch(error) {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        errorMessageElement.textContent = error.message || 'An error occurred while fetching the car.';
                };


                
                

                

                function getPriceBounds(year) {
                    let currentYear = new Date().getFullYear();
                    let age = currentYear - year;

                    if (age < 5) {
                        return { lowerBound: 20000, upperBound: 5000000 }; // Newer used cars
                    } else if (age < 10) {
                        return { lowerBound: 7000, upperBound: 2000000 }; // Moderately old cars
                    } else {
                        return { lowerBound: 2000, upperBound: 150000 }; // Older used cars
                    }
                }

                function extractPrices(text, year){
                    let bounds = getPriceBounds(year);
                    // Look for patterns like $XX,XXX.XX or $XX.XX or $XXXX
                    let priceRegex = /\$\d{1,3}(,\d{3})*(\.\d{2})?/g;
                    let matches = text.match(priceRegex);
                    let prices = matches ? matches.map(match => match.replace(/[\$,]/g, '')) : [];
                    let filteredPrices = [];
                    let price;

                    for (price of prices){
                        let numericPrice = parseFloat(price);
                        if (numericPrice >= bounds.lowerBound && numericPrice <= bounds.upperBound){
                            filteredPrices.push(matches[prices.indexOf(price)]);
                            if (filteredPrices.length >= 3) break;
                        }
                    }
                    // Return first 3 prices
                    return filteredPrices;
                }
                // If car specs were found
                if (!invalidCar){
                    
                    // Car Prices
                    await fetch(`/webscraper?year=${yearInput}&make=${makeInput}&model=${modelInput}`)
                    .then(response => {
                        if(response.ok) {
                            return response.json();
                        } else {
                            if(response.status === 404) {
                                document.getElementById("loadingMessage").classList.add("hidden");
                                throw { message: "Price data not found" };
                            }
                            document.getElementById("loadingMessage").classList.add("hidden");
                            return response.json().then(error => { throw error });
                        }
                    })
                    .then(data => {
                        let textData = data.data;
                        let prices = extractPrices(textData, yearInput);
                        console.log(prices);

                        let numericPrices = prices.map(price => parseFloat(price.replace(/[\$,]/g, '')));
                        let minValue = Math.min(...numericPrices);
                        let maxValue = Math.max(...numericPrices);

                        let formattedMinValue = prices.find(price => parseFloat(price.replace(/[\$,]/g, '')) === minValue);
                        let formattedMaxValue = prices.find(price => parseFloat(price.replace(/[\$,]/g, '')) === maxValue);

                        
                        
                        let priceCard = document.createElement("div");
                        priceCard.classList.add("price-card");
                        priceCard.textContent = `${formattedMinValue} - ${formattedMaxValue}`;
                        priceContainer.appendChild(priceCard);

                        

                        
                    })
                    .catch(error => {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        errorMessageElement.textContent = error.message || 'An error occurred while fetching the price data.';
                    });




                    
                    
                    // Car Image
                    await fetch(`/GetImageUrl?searchTerm=&year=${yearInput}&make=${makeInput}&model=${modelInput}`)
                    .then(response => {
                        if(response.ok) {
                            return response.text();
                        } else {

                            document.getElementById("loadingMessage").classList.add("hidden");
                            throw new Error("Car image data not found");
                        }
                    })
                    .then(str => {
                        let parser = new DOMParser();
                        let xml = parser.parseFromString(str, "application/xml");
                        let imageUrl = xml.getElementsByTagName("string")[0].textContent;
                        console.log(imageUrl);

                        let imageElement = document.createElement("img");
                        imageElement.src = imageUrl;
                        imageElement.className = 'car-image';
                        
                        imageContainer.appendChild(imageElement);
                         
                    })
                    .catch(error => {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        console.error("Error:", error);
                    });

                    

                    // Safety Ratings
                    await fetch(`/SafetyRatings?year=${yearInput}&make=${makeInput}&model=${modelInput}`)
                    .then(response => {
                        if(response.ok) {
                            return response.json();

                        } else {
                            if(response.status === 404) {
                                document.getElementById("loadingMessage").classList.add("hidden");
                                throw { message: "Safety ratings data not found" };
                            }
                            document.getElementById("loadingMessage").classList.add("hidden");
                            return response.json().then(error => { throw error });
                        }
                        
                    })
                    .then(data => {
                        let vehicleIds = data.Results.map(result => result.VehicleId);
                        return Promise.all(vehicleIds.map(vehicleId => {
                            return fetch(`/SafetyRatings/VehicleId/${vehicleId}`)
                            .then(response => {
                                if (!response.ok){
                                    throw new Error('Vehicle safety rating data not found');
                                }
                                return response.json();
                            });
                        }));
                    })
                    .then(allRatings => {
                        let imageAppended = false;
                        let ratingsFound = false;

                        allRatings.forEach(ratingData => {
                            
                            if (ratingData.Results.length !== 0){
                                ratingsFound = true;
                                
                                let rating = ratingData.Results[0];
                                let card = document.createElement("div");
                                
                                card.classList.add("rating-card");


                                // description
                                let descriptionDiv = document.createElement("div");
                                descriptionDiv.textContent = `Description: ${rating.VehicleDescription}`;
                                card.appendChild(descriptionDiv);

                                // investigation count
                                let investigationDiv = document.createElement("div");
                                investigationDiv.textContent = `Investigation Count: ${rating.InvestigationCount}`;
                                card.appendChild(investigationDiv);
                                
                                // recalls count
                                let recallsDiv = document.createElement("div");
                                recallsDiv.textContent = `Recalls Count: ${rating.RecallsCount}`;
                                card.appendChild(recallsDiv);

                                // complaints count
                                let complaintsDiv = document.createElement("div");
                                complaintsDiv.textContent = `Complaints Count: ${rating.ComplaintsCount}`;
                                card.appendChild(complaintsDiv);

                                // lane departure warning
                                let laneDepDiv = document.createElement("div");
                                laneDepDiv.textContent = `NHTSA Lane Departure Warning: ${rating.NHTSALaneDepartureWarning}`;
                                card.appendChild(laneDepDiv);

                                // forward collision warning
                                let forwColDiv = document.createElement("div");
                                forwColDiv.textContent = `NHTSA Forward Collision Warning: ${rating.NHTSAForwardCollisionWarning}`;
                                card.appendChild(forwColDiv);

                                // electronic stability control
                                let elecStabDiv = document.createElement("div");
                                elecStabDiv.textContent = `NHTSA Electronic Stability Control: ${rating.NHTSAElectronicStabilityControl}`;
                                card.appendChild(elecStabDiv);

                                // side pole crash rating
                                let spRatingDiv = document.createElement("div");
                                spRatingDiv.textContent = `Side Pole Crash Rating: ${rating.SidePoleCrashRating}`;
                                card.appendChild(spRatingDiv);

                                // rollover possibility
                                let rolloverPosDiv = document.createElement("div");
                                rolloverPosDiv.textContent = `Rollover Possibility: ${rating.RolloverPossibility}`;
                                card.appendChild(rolloverPosDiv);

                                // rollover rating
                                let rolloverRatingDiv = document.createElement("div");
                                rolloverRatingDiv.textContent = `Rollover Rating: ${rating.RolloverRating}`;
                                card.appendChild(rolloverRatingDiv);

                                // side crash passenger side rating
                                let sideCPSDiv = document.createElement("div");
                                sideCPSDiv.textContent = `Side Crash Passenger Side Rating: ${rating.SideCrashPassengersideRating}`;
                                card.appendChild(sideCPSDiv);

                                // side crash driver side rating
                                let sideCDSDiv = document.createElement("div");
                                sideCDSDiv.textContent = `Side Crash Driver Side Rating: ${rating.SideCrashDriversideRating}`;
                                card.appendChild(sideCDSDiv);

                                // overall side crash rating
                                let overallSCRDiv = document.createElement("div");
                                overallSCRDiv.textContent = `Overall Side Crash Rating: ${rating.OverallSideCrashRating}`;
                                card.appendChild(overallSCRDiv);

                                // front crash passenger side rating
                                let frontCPSDiv = document.createElement("div");
                                frontCPSDiv.textContent = `Front Crash Passenger Side Rating: ${rating.FrontCrashPassengersideRating}`;
                                card.appendChild(frontCPSDiv);

                                // front crash driver side rating
                                let frontCDSDiv = document.createElement("div");
                                frontCDSDiv.textContent = `Front Crash Driver Side Rating: ${rating.FrontCrashDriversideRating}`;
                                card.appendChild(frontCDSDiv);

                                // overall front crash rating
                                let overallFCRDiv = document.createElement("div");
                                overallFCRDiv.textContent = `Overall Front Crash Rating: ${rating.OverallFrontCrashRating}`;
                                card.appendChild(overallFCRDiv);

                                // overall rating
                                let overallRDiv = document.createElement("div");
                                overallRDiv.textContent = `Overall Rating: ${rating.OverallRating}`;
                                card.appendChild(overallRDiv);

                                // Side Pole Picture
                                if (rating.SidePolePicture){
                                    let imgSP = document.createElement("img");
                                    imgSP.src = rating.SidePolePicture;
                                    //imgSP.className = '';
                                    imgSP.alt = "Side Pole Picture";
                                    card.appendChild(imgSP);
                                }

                                // Side Crash Picture
                                if (rating.SideCrashPicture){
                                    let imgSC = document.createElement("img");
                                    imgSC.src = rating.SideCrashPicture;
                                    //imgSC.className = '';
                                    imgSC.alt = "Side Crash Picture";
                                    card.appendChild(imgSC);
                                }

                                // Front Crash Picture
                                if (rating.FrontCrashPicture){
                                    let imgFC = document.createElement("img");
                                    imgFC.src = rating.FrontCrashPicture;
                                    //imgFC.className = '';
                                    imgFC.alt = "Front Crash Picture";
                                    card.appendChild(imgFC);
                                }

                                

                                // create and append download links to crash videos
                                function appendDownloadLink(videoUrl, description) {
                                    if (videoUrl) {
                                        let downloadLink = document.createElement('a');
                                        downloadLink.href = videoUrl;
                                        downloadLink.textContent = `Download ${description}`;
                                        downloadLink.className = 'download-video-link';
                                        downloadLink.download = ""; // suggest download on click
                                        card.appendChild(downloadLink); 
                                    }
                                }

                                
                                appendDownloadLink(rating.FrontCrashVideo, "Front Crash Video");
                                appendDownloadLink(rating.SideCrashVideo, "Side Crash Video");
                                appendDownloadLink(rating.SidePoleVideo, "Side Pole Video");
                                
                                
                                ratingsContainer.appendChild(card);

                                if (!imageAppended && imageContainer.children.length <= 1) {
                                
                                    // image
                                    if (rating.VehiclePicture){
                                        let img = document.createElement("img");
                                        img.src = rating.VehiclePicture;
                                        img.className = 'car-image';
                                        img.alt = "Vehicle Safety Rating Picture";
                                        imageContainer.appendChild(img);
                                        imageAppended = true; 
                                    }
                                    
                                }

                            } 
                            
                        });
                        
                        if (!ratingsFound){
                            let noRatingsCard = document.createElement("div");
                            noRatingsCard.classList.add("rating-card");


                            // No ratings results
                            noRatingsCard.textContent = `No Safety Ratings Results From NHTSA`;
                            ratingsContainer.appendChild(noRatingsCard);
                        }

                    
                    })
                    .catch(error => {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        errorMessageElement.textContent = error.message || 'An error occurred while fetching the ratings data.';
                    });

                    //put recalls etc here..


                }else{
                    document.getElementById("loadingMessage").classList.add("hidden");
                    throw { message: "Car not found" };
                }


                // Hide Searching Message
                document.getElementById("loadingMessage").classList.add("hidden");
                
                // Show Specs
                document.getElementById("car-specs-header").classList.remove("hidden");
                document.getElementById("car-specs-container").classList.remove("hidden");
                

                // Show Prices
                document.getElementById("prices-header").classList.remove("hidden");
                document.getElementById("price-container").classList.remove("hidden");
                

                // Show Images
                document.getElementById("car-images-header").classList.remove("hidden");
                document.getElementById("image-container").classList.remove("hidden");

                // Show Ratings
                document.getElementById("car-ratings-header").classList.remove("hidden");
                document.getElementById("ratings-container").classList.remove("hidden");
                
                // Auto scroll down to specs 
                document.getElementById('car-specs-container').scrollIntoView({ behavior: 'smooth', block: 'start' });

                
   
            }) //end of button click
            
             
            
                
            



             
            
        
        </script>
    </body>
</html>