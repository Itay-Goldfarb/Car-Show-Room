<!DOCTYPE html>
<html>
    <head>
        <title>CARROOM</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        
    </head>
    <body>
        <div id="form-container">
            <h1>Enter Car Details</h1>
            
            <div class="input-container">      
            <label for="year-input">Year:</label>
            <input type="text" id="year-input">
            </div>

            <div class="input-container">
                <label for="make-input">Make:</label>
                <input type="text" id="make-input">
            </div>

            <div class="input-container">      
                <label for="model-input">Model:</label>
                <input type="text" id="model-input">
            </div>

            <div class="input-container">      
                <button id="searchButton">Get Car</button>
                <p id="error-message"></p>
            </div>
        </div>
        

        <p id="loadingMessage" class="hidden">Searching...</p>
    
        <h2 id="car-specs-header" class="hidden">Specs</h2>
        <div id="car-specs-container" class="hidden">
        </div>

        

        <h3 id="prices-header" class="hidden">Estimated Prices</h3>
        <div id="price-container" class="hidden">
        </div>

        

        

        <h4 id="car-images-header" class="hidden">Car Image</h4>
        <div id="image-container" class="hidden">
        </div>
    
        <script>
            let carButton = document.getElementById("searchButton");
            
            
            
            carButton.addEventListener("click", async () => {
                
                
                document.getElementById("car-specs-container").classList.add("hidden");
                document.getElementById("car-specs-header").classList.add("hidden");
                document.getElementById("prices-header").classList.add("hidden");
                document.getElementById("car-images-header").classList.add("hidden");

                document.getElementById("loadingMessage").classList.remove("hidden");
                
                yearInput = document.getElementById("year-input").value;
                makeInput = document.getElementById("make-input").value;
                modelInput = document.getElementById("model-input").value;

                

                errorMessageElement = document.getElementById("error-message");

                specsContainer = document.getElementById("car-specs-container");
                imageContainer = document.getElementById("image-container"); 
                priceContainer = document.getElementById("price-container");

                while(specsContainer.firstChild) {
                    specsContainer.removeChild(specsContainer.firstChild);
                }
                
                
                while(priceContainer.firstChild) {
                    priceContainer.removeChild(priceContainer.firstChild);
                }

                

                while(imageContainer.firstChild) {
                    imageContainer.removeChild(imageContainer.firstChild);
                }




                if (!yearInput || !makeInput || !modelInput){
                    document.getElementById("loadingMessage").classList.add("hidden");
                    errorMessageElement.textContent = "Please enter Year, Make, and Model";
                    return;
                }
                errorMessageElement.textContent = "";

                
                let invalidCar = false;
                try{ 
                    let carSpecResponse = await fetch(`/cars?year=${yearInput}&make=${makeInput}&model=${modelInput}`);
                        
                        if(!carSpecResponse.ok) {
                            if (carSpecResponse.status === 404){
                                document.getElementById("loadingMessage").classList.add("hidden");
                                throw new Error("Car not found");
                            }
                            let errorData = await carSpecResponse.json();
                            document.getElementById("loadingMessage").classList.add("hidden");
                            throw new Error(errorData.message || 'An error occurred while fetching the car.');
                            
                        } 
                        let carsData = await carSpecResponse.json();

                        if (carsData.length === 0){
                            invalidCar = true;
                            document.getElementById("loadingMessage").classList.add("hidden");
                            throw new Error("Car not found");
                        }

                        
                        
                                
                        carsData.forEach(car => {
                        
                            let card = document.createElement("div");
                            card.classList.add("spec-card");

                            // Add make
                            let makeDiv = document.createElement("div");
                            makeDiv.textContent = `Make: ${car.make}`;
                            card.appendChild(makeDiv);

                            // Add model
                            let modelDiv = document.createElement("div");
                            modelDiv.textContent = `Model: ${car.model}`;
                            card.appendChild(modelDiv);

                            // Add year
                            let yearDiv = document.createElement("div");
                            yearDiv.textContent = `Year: ${car.year}`;
                            card.appendChild(yearDiv);

                            // Add class
                            let classDiv = document.createElement("div");
                            classDiv.textContent = `Class: ${car.class}`;
                            card.appendChild(classDiv);

                            // Add fuel type
                            let fuelTypeDiv = document.createElement("div");
                            fuelTypeDiv.textContent = `Fuel Type: ${car.fuel_type}`;
                            card.appendChild(fuelTypeDiv);

                            // Add drivetrain
                            let driveDiv = document.createElement("div");
                            driveDiv.textContent = `Drivetrain: ${car.drive}`;
                            card.appendChild(driveDiv);

                            // Add cylinders
                            let cylinderDiv = document.createElement("div");
                            cylinderDiv.textContent = `Cylinders: ${car.cylinders}`;
                            card.appendChild(cylinderDiv);

                            // Add transmission
                            let transDiv = document.createElement("div");
                            transDiv.textContent = `Transmission: ${car.transmission}`;
                            card.appendChild(transDiv);

                            // Add city MPG
                            let cityMPGDiv = document.createElement("div");
                            cityMPGDiv.textContent = `City MPG: ${car.city_mpg}`;
                            card.appendChild(cityMPGDiv);

                            // Add highway MPG
                            let hwyMPGDiv = document.createElement("div");
                            hwyMPGDiv.textContent = `Highway MPG: ${car.highway_mpg}`;
                            card.appendChild(hwyMPGDiv);

                            // Add combination MPG
                            let combMPGDiv = document.createElement("div");
                            combMPGDiv.textContent = `Combination MPG: ${car.combination_mpg}`;
                            card.appendChild(combMPGDiv);

                            // Append the card to the container
                            specsContainer.appendChild(card);
                        });   
                }catch(error) {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        errorMessageElement.textContent = error.message || 'An error occurred while fetching the car.';
                };


                
                

                

                function getPriceBounds(year) {
                    let currentYear = new Date().getFullYear();
                    let age = currentYear - year;

                    if (age < 5) {
                        return { lowerBound: 20000, upperBound: 2000000 }; // Newer used cars
                    } else if (age < 10) {
                        return { lowerBound: 7000, upperBound: 200000 }; // Moderately old cars
                    } else {
                        return { lowerBound: 2000, upperBound: 150000 }; // Older used cars
                    }
                }

                function extractPrices(text, year){
                    let bounds = getPriceBounds(year);
                    // Look for patterns like $XX,XXX.XX or $XX.XX or $XXXX
                    let priceRegex = /\$\d{1,3}(,\d{3})*(\.\d{2})?/g;
                    let matches = text.match(priceRegex);
                    let prices = matches ? matches.map(match => match.replace(/[\$,]/g, '')) : [];
                    let filteredPrices = [];
                    let price;

                    for (price of prices){
                        let numericPrice = parseFloat(price);
                        if (numericPrice >= bounds.lowerBound && numericPrice <= bounds.upperBound){
                            filteredPrices.push(matches[prices.indexOf(price)]);
                            if (filteredPrices.length >= 3) break;
                        }
                    }
                    // Return first 3 prices
                    return filteredPrices;
                }
                // If car specs were found
                if (!invalidCar){
                    
                    await fetch(`/webscraper?year=${yearInput}&make=${makeInput}&model=${modelInput}`)
                    .then(response => {
                        if(response.ok) {
                            return response.json();
                        } else {
                            if(response.status === 404) {
                                document.getElementById("loadingMessage").classList.add("hidden");
                                throw { message: "Price data not found" };
                            }
                            document.getElementById("loadingMessage").classList.add("hidden");
                            return response.json().then(error => { throw error });
                        }
                    })
                    .then(data => {
                        let textData = data.data;
                        let prices = extractPrices(textData, yearInput);
                        console.log(prices);

                        prices.forEach(price => {
                            let priceCard = document.createElement("div");
                            priceCard.classList.add("price-card");
                            priceCard.textContent = `${price}`;
                            priceContainer.appendChild(priceCard);
                        });   
                    })
                    .catch(error => {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        errorMessageElement.textContent = error.message || 'An error occurred while fetching the price data.';
                    });




                    
                    
                    
                    await fetch(`/GetImageUrl?searchTerm=&year=${yearInput}&make=${makeInput}&model=${modelInput}`)
                    .then(response => {
                        if(response.ok) {
                            return response.text();
                        } else {

                            document.getElementById("loadingMessage").classList.add("hidden");
                            throw new Error("Car image data not found");
                        }
                    })
                    .then(str => {
                        let parser = new DOMParser();
                        let xml = parser.parseFromString(str, "application/xml");
                        let imageUrl = xml.getElementsByTagName("string")[0].textContent;
                        console.log(imageUrl);

                        let imageElement = document.createElement("img");
                        imageElement.src = imageUrl;
                        imageElement.className = 'car-image';
                        
                        imageContainer.appendChild(imageElement);
                         
                    })
                    .catch(error => {
                        document.getElementById("loadingMessage").classList.add("hidden");
                        console.error("Error:", error);
                    });


                }else{
                    document.getElementById("loadingMessage").classList.add("hidden");
                    throw { message: "Car not found" };
                }


                // Hide Searching Message
                document.getElementById("loadingMessage").classList.add("hidden");
                // Show Specs
                document.getElementById("car-specs-header").classList.remove("hidden");
                document.getElementById("car-specs-container").classList.remove("hidden");
                

                // Show Prices
                document.getElementById("prices-header").classList.remove("hidden");
                document.getElementById("price-container").classList.remove("hidden");
                

                // Show Images
                document.getElementById("car-images-header").classList.remove("hidden");
                document.getElementById("image-container").classList.remove("hidden");
                
   
            }) //end of button click
            
             
            
                
            



             
            
        
        </script>
    </body>
</html>