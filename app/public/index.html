<!DOCTYPE html>
<html>
    <head>
        <title>CARROOM</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <h1>Enter Car Details</h1>
    </head>
    <body>
        <div class="container">      
            <label for="year-input">Year:</label>
            <input type="text" id="year-input">
        </div>

        <div class="container">
            <label for="make-input">Make:</label>
            <input type="text" id="make-input">
        </div>

        <div class="container">      
            <label for="model-input">Model:</label>
            <input type="text" id="model-input">
        </div>

        <div class="container">      
            <button id="searchButton">Get Car</button>
            <p id="error-message" style="color:red;"></p>
        </div>
    
        <table>
            <thead>
                <tr>
                    <th>Make</th>
                    <th>Model</th>
                    <th>Year</th>
                    <th>Class</th>
                    <th>Fuel Type</th>
                    <th>Drivetrain</th>
                    <th>Cylinders</th>
                    <th>Transmission</th>
                    <th>City MPG</th>
                    <th>Highway MPG</th>
                    <th>Combination MPG</th>
                    
                    
                </tr>
            </thead>
            <tbody id="car-table-body">
            </tbody>
        </table>

        <table>
            <thead>
                <tr>
                    <th>Price Data</th>
                    
                </tr>
            </thead>
            <tbody id="price-table-body">
            </tbody>
        </table>

        

        <h2 id="car-images-header">Car Images</h2>
        <div id="image-container" style="display: flex; flex-wrap: wrap; gap: 10px;">
        </div>
    
        <script>
            let carButton = document.getElementById("searchButton");
            
            
            carButton.addEventListener("click", () => {
                yearInput = document.getElementById("year-input").value;
                makeInput = document.getElementById("make-input").value;
                modelInput = document.getElementById("model-input").value;

                

                errorMessageElement = document.getElementById("error-message");
                tableBodyElement = document.getElementById("car-table-body");
    
                while(tableBodyElement.firstChild) {
                    tableBodyElement.removeChild(tableBodyElement.firstChild);
                }

                if (!yearInput || !makeInput || !modelInput){
                    errorMessageElement.textContent = "Please enter Year, Make, and Model";
                    return;
                }
                errorMessageElement.textContent = "";

                
    
                fetch(`/cars?year=${yearInput}&make=${makeInput}&model=${modelInput}`)
                    .then(response => {
                        if(response.ok) {
                            return response.json();
                        } else {
                            if(response.status === 404) {
                                throw { message: "Car not found" };
                            }
                            return response.json().then(error => { throw error });
                        }
                    })
                    .then(data => {
                        data.forEach(cars => {
                            row = document.createElement("tr");
                            
    
                            makeCell = document.createElement("td");
                            makeCell.textContent = cars.make;
                            row.appendChild(makeCell);
    
                            modelCell = document.createElement("td");
                            modelCell.textContent = cars.model;
                            row.appendChild(modelCell);
    
                            yearCell = document.createElement("td");
                            yearCell.textContent = cars.year;
                            row.appendChild(yearCell);

                            classCell = document.createElement("td");
                            classCell.textContent = cars.class;
                            row.appendChild(classCell);

                            fuelTypeCell = document.createElement("td");
                            fuelTypeCell.textContent = cars.fuel_type;
                            row.appendChild(fuelTypeCell);

                            driveCell = document.createElement("td");
                            driveCell.textContent = cars.drive;
                            row.appendChild(driveCell);

                            cylinderCell = document.createElement("td");
                            cylinderCell.textContent = cars.cylinders;
                            row.appendChild(cylinderCell);


                            transCell = document.createElement("td");
                            transCell.textContent = cars.transmission;
                            row.appendChild(transCell);

                            cityMPGCell = document.createElement("td");
                            cityMPGCell.textContent = cars.city_mpg;
                            row.appendChild(cityMPGCell);

                            hwyMPGCell = document.createElement("td");
                            hwyMPGCell.textContent = cars.highway_mpg;
                            row.appendChild(hwyMPGCell);

                            combMPGCell = document.createElement("td");
                            combMPGCell.textContent = cars.combination_mpg;
                            row.appendChild(combMPGCell);
                            
                            
    
                            tableBodyElement.appendChild(row);
                        });
                    })
                    .catch(error => {
                        errorMessageElement.textContent = error.message || 'An error occurred while fetching the car.';
                    });



                
                priceTableBodyElement = document.getElementById("price-table-body");
    
                while(priceTableBodyElement.firstChild) {
                    priceTableBodyElement.removeChild(priceTableBodyElement.firstChild);
                }

                function getPriceBounds(year) {
                    let currentYear = new Date().getFullYear();
                    let age = currentYear - year;

                    if (age < 5) {
                        return { lowerBound: 20000, upperBound: 2000000 }; // Newer used cars
                    } else if (age < 10) {
                        return { lowerBound: 7000, upperBound: 200000 }; // Moderately old cars
                    } else {
                        return { lowerBound: 2000, upperBound: 150000 }; // Older used cars
                    }
                }

                function extractPrices(text, year){
                    let bounds = getPriceBounds(year);
                    // Look for patterns like $XX,XXX.XX or $XX.XX or $XXXX
                    let priceRegex = /\$\d{1,3}(,\d{3})*(\.\d{2})?/g;
                    let matches = text.match(priceRegex);
                    let prices = matches ? matches.map(match => match.replace(/[\$,]/g, '')) : [];
                    let filteredPrices = [];
                    let price;

                    for (price of prices){
                        let numericPrice = parseFloat(price);
                        if (numericPrice >= bounds.lowerBound && numericPrice <= bounds.upperBound){
                            filteredPrices.push(matches[prices.indexOf(price)]);
                            if (filteredPrices.length >= 3) break;
                        }
                    }
                    // Return first 3 prices
                    return filteredPrices;
                }

                fetch(`/webscraper?year=${yearInput}&make=${makeInput}&model=${modelInput}`)
                .then(response => {
                

                    if(response.ok) {
                        return response.json();
                    } else {
                        if(response.status === 404) {
                            throw { message: "Price data not found" };
                        }
                        return response.json().then(error => { throw error });
                    }
                })
                .then(data => {
                    
                    let textData = data.data;
                    let prices = extractPrices(textData, yearInput);
                    console.log(prices);
                    
                    row = document.createElement("tr");
                        
                    priceCell = document.createElement("td");
                    priceCell.textContent = prices;
                    row.appendChild(priceCell);

                    priceTableBodyElement.appendChild(row);
                        
                    
                })
                .catch(error => {
                    errorMessageElement.textContent = error.message || 'An error occurred while fetching the price data.';
                    
                });




                let imageContainer = document.getElementById("image-container");
    
                while(imageContainer.firstChild) {
                    imageContainer.removeChild(imageContainer.firstChild);
                }
                
                
                fetch(`/search?query=&make=${makeInput}&model=${modelInput}&year=${yearInput}&per_page=3`)
                .then(response => {
                

                    if(response.ok) {
                        return response.json();
                    } else {
                        if(response.status === 404) {
                            throw { message: "Car image data not found" };
                        }
                        return response.json().then(error => { throw error });
                    }
                })
                .then(data => {
                    
                    
                    data.photos.forEach(photo => {

                    
                        let imageElement = document.createElement("img");
                        imageElement.src = photo.src.medium;
                        imageElement.alt = photo.alt;
                        imageElement.style.width = "auto";
                        imageElement.style.height = "auto";
                        
                        imageContainer.appendChild(imageElement);
                        
                    });
                
                    
                })
                .catch(error => {
                    console.error("Error:", error.message);
                    
                });
                
            



            }) //end of button click
            
        
        </script>
    </body>
</html>